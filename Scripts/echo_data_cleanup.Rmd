---
title: "Echo data cleanup"
output: html_notebook
---
This is the R cleanup of the exported echo data files after processing in Python to find the surface and average bins into a more manageable file size for analysis in R.

Packages

```{r, message=FALSE}
library(tidyverse)
library(lubridate)
library(stringr)

```

Read in files

```{r, message = FALSE}
ekkoT2<-
  list.files("New exports",recursive=T,pattern = "2_") %>% 
  map_df(~read_csv(paste("New exports", ., sep = "/")))

ekkoT1<-
  list.files("New exports",recursive=T,pattern = "1_") %>% 
  map_df(~read_csv(paste("New exports", ., sep = "/")))
```

Cleanup

```{r}
#T1 is the "South" echo sounder and T2 is the "North" echo sounder
T1<-ekkoT1 %>% 
  subset(Sv>-300) %>% #This removes autogenerated empty cells produced as part of the export in Python.
  mutate(depth=depth*-1) %>%  #Make depth negative
  group_by(time) %>% 
  arrange(depth) %>% 
  slice(-(1:21)) %>% #Remove the bins between the bottom of the cage and the echo sounder
  subset(depth < -1) %>% #Remove the top 1 metre to ensure there's no surface signal in the data
  mutate(depth = depth+1) %>% #Move the depths accordingly
  droplevels() %>% 
  mutate(depth= round(depth/0.165)*0.165) %>% #Ensuring all of the depth bins are the same makes plotting with geom_tile easier
  mutate(tenmin=round_date(time,"10 mins")) %>% 
  mutate(hourly=round_date(time, "hour")) %>%  
  arrange(time) %>% 
  filter(!(time >= as.POSIXct('2020-02-10 09:00:00 ') & time <= as.POSIXct('2020-02-10 17:00:00'))) %>% #Remove some faulty data
  mutate(hour = hour(time)) #Gera ein variabul, sum sigur tíman á degnum (0-23)


T2<-ekkoT2 %>% 
  subset(Sv>-300) %>% 
  mutate(depth=depth*-1) %>% 
  group_by(time) %>% 
  arrange(depth) %>% 
  slice(-(1:21)) %>% 
  subset(depth < -1) %>% 
  mutate(depth = depth+1) %>% 
  droplevels() %>% 
  mutate(depth= round(depth/.165)*.165) %>% 
  mutate(tenmin=round_date(time,"10 mins")) %>% 
  mutate(hourly=round_date(time, "hour")) %>% 
  arrange(time) %>% 
  filter(!(time >= as.POSIXct('2020-02-10 09:00:00 ') & time <= as.POSIXct('2020-02-10 17:00:00'))) %>% 
  mutate(hour = hour(time))
  
  
```

```{r}

write_csv(T1, "T1clean.csv")
write_csv(T2, "T2clean.csv")



```

